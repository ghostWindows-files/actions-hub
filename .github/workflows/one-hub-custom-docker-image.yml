name: one-hub å‰ç«¯ä¿®æ”¹

on:
  #  schedule:
  #    - cron: '0 0 * * *'  # æ¯å¤© UTC 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-updates:
    name: one-hub æ›´æ–°æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.final_check.outputs.should_build }}
    continue-on-error: true
    permissions:
      issues: write
    env:
      TZ: Asia/Shanghai
      RETRY_COUNT: 3  # API é‡è¯•æ¬¡æ•°
      RETRY_DELAY: 2  # é‡è¯•åŸºç¡€ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰

    steps:
      # ========== æ•°æ®è·å– ==========
      - name: è·å–ä»“åº“å¿«ç…§
        id: repo_snapshot
        run: |
          echo "=== å¼€å§‹è·å–ä»“åº“å¿«ç…§ ==="
          
          # è·å– one-hub ä»“åº“æœ€æ–°æäº¤
          echo "è·å– one-hub ä»“åº“æœ€æ–°æäº¤..."
          main_commit=$(curl -fsS "https://api.github.com/repos/MartialBE/one-hub/commits/main")
          main_sha=$(jq -r '.sha[0:7]' <<< "$main_commit")
          main_timestamp=$(jq -r '.commit.committer.date' <<< "$main_commit")
          echo "one-hub ä»“åº“ SHA: $main_sha (æ—¶é—´: $main_timestamp)"
          
          # è·å– TableRow ä¿¡æ¯
          echo "è·å– TableRow ä¿¡æ¯"
          table_commit=$(curl -fsS "https://api.github.com/repos/MartialBE/one-hub/commits?path=web/src/views/Channel/component/TableRow.jsx&until=$main_timestamp")
          table_sha=$(jq -r 'if length>0 then .[0].sha[0:7] else "null" end' <<< "$table_commit")
          echo "TableRow SHA: $table_sha"
          
          # å­˜å‚¨ç¯å¢ƒå˜é‡
          echo "å­˜å‚¨ç¯å¢ƒå˜é‡..."
          echo "MAIN_SHA=$main_sha" >> $GITHUB_ENV
          echo "MAIN_TIMESTAMP=$main_timestamp" >> $GITHUB_ENV
          echo "TABLE_SHA=$table_sha" >> $GITHUB_ENV
          
          echo "=== ä»“åº“å¿«ç…§è·å–å®Œæˆ ==="

      
      # ========== Issue ç®¡ç† ==========
      - name: ç®¡ç†è¿½è¸ª Issue
        id: issue_manager
        env:
          ISSUE_TITLE: "one-hub-tracker"
        run: |
          echo "=== å¼€å§‹ç®¡ç†è¿½è¸ª Issue ==="
          
          # å¸¦é‡è¯•çš„ Issue æŸ¥è¯¢
          echo "æŸ¥è¯¢ç°æœ‰ Issue..."
          for i in {1..3}; do
            issues=$(curl -fsS "https://api.github.com/repos/${{ github.repository }}/issues?state=open" |
              jq --arg title "$ISSUE_TITLE" '[.[] | select(.title == $title)]')
            if [ $(jq 'length' <<< "$issues") -gt 0 ]; then
              echo "æ‰¾åˆ°ç°æœ‰ Issue"
              break
            fi
            echo "æœªæ‰¾åˆ° Issueï¼Œé‡è¯• $i/3..."
            sleep $((i*2))
          done
                 
          if [ $(jq 'length' <<< "$issues") -eq 0 ]; then
            # é¦–æ¬¡åˆ›å»º Issue ======================
            echo "æ„å»º Issue å†…å®¹..."
            issue_body=$(jq -n \
              --arg main "${{ env.MAIN_SHA }}" \
              --arg table "${{ env.TABLE_SHA }}" \
              --arg ts "${{ env.MAIN_TIMESTAMP }}" \
              '{
                repo_sha: $main,
                TableRow_file_sha: $table,
                timestamp: $ts
              }')
            
            echo "=== åˆ›å»ºæ–° Issue ==="
            response=$(curl -fsS -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg title "$ISSUE_TITLE" --argjson body "$issue_body" '{title: $title, body: $body|tojson}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues")
            echo "âœ… å·²åˆ›å»º Issue: $(jq -r '.html_url' <<< "$response")"
            echo "main_updated=true" >> $GITHUB_OUTPUT  # é¦–æ¬¡åˆ›å»ºæ—¶å¼ºåˆ¶è§¦å‘æ„å»º
            echo "table_updated=false" >> $GITHUB_OUTPUT  # é¦–æ¬¡åˆ›å»ºä¸è§¦å‘ TableRow æ›´æ–°
            echo "is_first_run=true" >> $GITHUB_OUTPUT  # æ ‡è®°ä¸ºé¦–æ¬¡è¿è¡Œ
            
          else
            # å­˜åœ¨ç°æœ‰ Issue ======================
            issue_id=$(jq -r '.[0].number' <<< "$issues")
            existing_body=$(jq -r '.[0].body' <<< "$issues")
            echo "ç°æœ‰ Issue ID: $issue_id"
            echo "ç°æœ‰ Issue å†…å®¹: $existing_body"
        
            # è§£æç°æœ‰ Issue å†…å®¹
            existing_data=$(echo "$existing_body" | jq -R fromjson)
            if [ $? -ne 0 ]; then
              echo "::error::æ— æ³•è§£æç°æœ‰ Issue å†…å®¹"
              exit 1
            fi
        
            # è·å–æ—§ SHA å€¼
            old_main_sha=$(jq -r '.repo_sha' <<< "$existing_data")
            current_main_sha="${{ env.MAIN_SHA }}"
            old_table_sha=$(jq -r '.TableRow_file_sha' <<< "$existing_data")
            current_table_sha="${{ env.TABLE_SHA }}"
            echo "æ—§ä»“åº“ SHA: $old_main_sha"
            echo "æ–°ä»“åº“ SHA: $current_main_sha"
            echo "æ—§ TableRow SHA: $old_table_sha"
            echo "æ–° TableRow SHA: $current_table_sha"
            
            # æ¯”è¾ƒé€»è¾‘
            main_updated=false
            if [ "$current_main_sha" != "$old_main_sha" ]; then
              echo "ğŸ”„ æ£€æµ‹åˆ° one-hub ä»“åº“æ›´æ–°"
              main_updated=true
            else
              echo "âœ… one-hub ä»“åº“æœªæ›´æ–°"
            fi
                      
            # æ¯”è¾ƒ TableRow SHA
            table_updated=false
            if [ "$current_table_sha" != "$old_table_sha" ]; then
              echo "ğŸ”„ æ£€æµ‹åˆ° TableRow æ›´æ–°"
              table_updated=true
            else
              echo "âœ… TableRow æœªæ›´æ–°, ä¸å‘é€é€šçŸ¥"
            fi
            
            # ä»…åœ¨éœ€è¦æ—¶æ›´æ–° Issue
            if [ "$main_updated" == "true" ]; then
              # æ›´æ–° Issue
              issue_body=$(jq -n \
                --arg main "${{ env.MAIN_SHA }}" \
                --arg table "${{ env.TABLE_SHA }}" \
                --arg ts "${{ env.MAIN_TIMESTAMP }}" \
                --argjson old "$existing_data" \
                '$old + {
                  TableRow_file_sha: $table,
                  repo_sha: $main,
                  timestamp: $ts
                }')
              
              echo "=== æ›´æ–° Issue ==="
              response=$(curl -fsS -X PATCH \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --argjson body "$issue_body" '{body: $body|tojson}')" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$issue_id")
              
              # æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸ
              if [ $? -eq 0 ]; then
                echo "âœ… Issue æ›´æ–°æˆåŠŸ"
                # æ‰“å°æ›´æ–°åçš„ Issue å†…å®¹ï¼ˆä»… body å­—æ®µï¼‰
                echo "=== æ›´æ–°åçš„ Issue å†…å®¹ ==="
                echo "$response" | jq -r '.body'  # ä½¿ç”¨ -r é€‰é¡¹å»é™¤ JSON å­—ç¬¦ä¸²çš„å¼•å·
                echo "==========================="
              else
                echo "âŒ Issue æ›´æ–°å¤±è´¥"
                exit 1
              fi
            else
              echo "â¸ï¸ æ— éœ€æ›´æ–° Issueï¼šone-hub ä»“åº“å’Œ TableRow å‡æœªæ›´æ–°"
            fi
            
            # è®¾ç½®è¾“å‡ºå˜é‡
            echo "main_updated=$main_updated" >> $GITHUB_OUTPUT
            echo "table_updated=$table_updated" >> $GITHUB_OUTPUT
            echo "is_first_run=false" >> $GITHUB_OUTPUT  # æ ‡è®°ä¸ºéé¦–æ¬¡è¿è¡Œ
          fi
          echo "=== Issue ç®¡ç†å®Œæˆ ==="

      # ========== æœ€ç»ˆæ£€æŸ¥ ==========
      - name: æ„å»ºå†³ç­–
        id: final_check
        run: |
          echo "=== å¼€å§‹æœ€ç»ˆæ£€æŸ¥ ==="
          if [[ "${{ steps.issue_manager.outputs.main_updated }}" == "true" ]]; then
            echo "ğŸ“¦ éœ€è¦æ‰§è¡Œæ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "â¸ï¸ è·³è¿‡æ„å»º"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
          echo "=== æœ€ç»ˆæ£€æŸ¥å®Œæˆ ==="

      - name: å‘é€TableRowé€šçŸ¥
        if: steps.issue_manager.outputs.table_updated  == 'true'
        uses: candies404/Multi-Channel-Notifier@latest
        with:
          title: "TableRowç»„ä»¶æ›´æ–°"
          content: "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»æŸ¥çœ‹ï¼š[TableRow.jsx](https://github.com/MartialBE/one-hub/blob/main/web/src/views/Channel/component/TableRow.jsx)"
          hitokoto: 'false'
          wpush_key : ${{ secrets.WPUSH_KEY }}

  build-deploy:
    name: æ„å»ºéƒ¨ç½²
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
      - name: æ£€å‡º MartialBE/one-hub
        uses: actions/checkout@v4
        with:
          repository: MartialBE/one-hub
          path: ""

      - name: æ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: source-repo

      - name: ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
        run: |
          echo "=== ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯ ==="
          HASH=$(git rev-parse --short=7 HEAD)
          echo "å½“å‰æäº¤å“ˆå¸Œ: $HASH"
          echo "dev-$HASH" > VERSION
          echo "ç‰ˆæœ¬æ–‡ä»¶å†…å®¹: $(cat VERSION)"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.4.1

      - name: ç¼“å­˜ Node æ¨¡å—
        uses: actions/cache@v4
        with:
          path: |
            web/node_modules
            ~/.cache/yarn
          key: ${{ runner.os }}-node-${{ hashFiles('web/yarn.lock') }}

      - name: æ„å»ºå‰ç«¯
        env:
          CI: ""
        run: |
          echo "=== å¼€å§‹æ„å»ºå‰ç«¯ ==="
          export VERSION=$(cat VERSION)
          echo "å½“å‰ç‰ˆæœ¬: $VERSION"
          cp source-repo/one-hub/TableRow.jsx web/src/views/Channel/component/TableRow.jsx
          echo "TableRow.jsx å·²æ›¿æ¢"
          cd web
          yarn install
          VITE_APP_VERSION=$VERSION yarn run build
          echo "å‰ç«¯æ„å»ºå®Œæˆ"

      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: ">=1.18.0"

      - name: ç¼–è¯‘åç«¯ (amd64)
        run: |
          echo "=== ç¼–è¯‘åç«¯ (amd64) ==="
          go mod download
          go build -ldflags "-s -w -X 'one-api/common/config.Version=$(cat VERSION)' -extldflags '-static'" -o one-api-amd64
          echo "amd64 ç¼–è¯‘å®Œæˆ"

      - name: ç¼–è¯‘åç«¯ (arm64)
        run: |
          echo "=== ç¼–è¯‘åç«¯ (arm64) ==="
          sudo rm /etc/apt/sources.list.d/microsoft-prod.list
          sudo apt-get update
          sudo apt-get install gcc-aarch64-linux-gnu
          CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -X 'one-api/common/config.Version=$(cat VERSION)' -extldflags '-static'" -o one-api-arm64
          echo "arm64 ç¼–è¯‘å®Œæˆ"

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/one-hub
          tags: |
            type=raw,value=latest

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          file: Dockerfile-action
