name: æ£€æŸ¥ä»“åº“æ›´æ–°

# è§¦å‘æ¡ä»¶
on:
  # schedule:
  #   - cron: '0 0 * * *'  # æ¯å¤© UTC 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# å·¥ä½œæµä»»åŠ¡
jobs:
  check-updates:
    name: 'æ£€æŸ¥ä»“åº“æ›´æ–°'
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai    # æ·»åŠ å…¨å±€æ—¶åŒºè®¾ç½®
    permissions:
      issues: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤1: æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨äºå­˜å‚¨SHAçš„Issue
      - name: æŸ¥æ‰¾æˆ–åˆ›å»ºå­˜å‚¨SHAçš„Issue
        id: get-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL="commit-sha-storage"

          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          label_exists=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                        -H "Accept: application/vnd.github.v3+json" \
                        "https://api.github.com/repos/${{ github.repository }}/labels/${LABEL}" | jq -r '.name // empty')

          if [ -z "$label_exists" ]; then
            echo "åˆ›å»ºæ ‡ç­¾ ${LABEL}..."
            curl -s -X POST \
                 -H "Authorization: token ${GITHUB_TOKEN}" \
                 -H "Accept: application/vnd.github.v3+json" \
                 "https://api.github.com/repos/${{ github.repository }}/labels" \
                 -d "{\"name\": \"${LABEL}\", \"description\": \"ç”¨äºæ ‡è®°å­˜å‚¨commit SHAçš„issue\", \"color\": \"0366d6\"}"
          else
            echo "æ ‡ç­¾ ${LABEL} å·²å­˜åœ¨"
          fi

          # æŸ¥æ‰¾å¸¦æœ‰è¯¥æ ‡ç­¾çš„Issue
          echo "æŸ¥æ‰¾å¸¦æœ‰ ${LABEL} æ ‡ç­¾çš„Issue..."
          issues_response=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                          -H "Accept: application/vnd.github.v3+json" \
                          "https://api.github.com/repos/${{ github.repository }}/issues?labels=${LABEL}&state=all")

          issue_number=$(echo "$issues_response" | jq -r '.[0].number // empty')

          if [ -z "$issue_number" ]; then
            echo "æœªæ‰¾åˆ°å­˜å‚¨Issueï¼Œåˆ›å»ºæ–°Issue..."
            create_response=$(curl -s -X POST \
                            -H "Authorization: token ${GITHUB_TOKEN}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            "https://api.github.com/repos/${{ github.repository }}/issues" \
                            -d '{
                              "title": "Commit SHA Storage",
                              "body": "",
                              "labels": ["commit-sha-storage"]
                            }')
            issue_number=$(echo "$create_response" | jq -r '.number')
            echo "åˆ›å»ºçš„Issueç¼–å·: $issue_number"
          else
            echo "æ‰¾åˆ°ç°æœ‰Issueç¼–å·: $issue_number"
          fi

          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT

      # æ­¥éª¤2: è¯»å–å­˜å‚¨çš„SHA
      - name: è¯»å–å­˜å‚¨çš„SHA
        id: read-shas
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number=${{ steps.get-issue.outputs.issue_number }}
          response=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${{ github.repository }}/issues/${issue_number}")
          
          if [ $? -ne 0 ]; then
            echo "âŒ è·å– Issue å†…å®¹å¤±è´¥"
            exit 1
          fi
          
          stored_shas=$(echo "$response" | jq -r '.body // ""')
          
          # éªŒè¯å­˜å‚¨çš„SHAæ ¼å¼
          if [ -n "$stored_shas" ]; then
            # å…ˆæ¸…ç†è¾“å…¥ï¼Œå»é™¤å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            cleaned_shas=$(echo "$stored_shas" | tr -d '\r' | sed '/^$/d')
            # æ£€æŸ¥æ¯ä¸€è¡Œæ˜¯å¦ç¬¦åˆ "ä»“åº“:7ä½SHA" çš„æ ¼å¼
            if echo "$cleaned_shas" | grep -qE '^([^:]+:[a-f0-9]{7})?$'; then
              echo "âœ… SHAæ ¼å¼éªŒè¯é€šè¿‡"
            else
              echo "âŒ å­˜å‚¨çš„SHAæ ¼å¼ä¸æ­£ç¡®"
              echo "å½“å‰å†…å®¹: ${stored_shas}"
              echo "âš ï¸ è§†ä¸ºé¦–æ¬¡è¿è¡Œå¤„ç†"
              stored_shas=""
            fi
          else
            echo "âš ï¸ å­˜å‚¨å†…å®¹ä¸ºç©ºï¼Œè§†ä¸ºé¦–æ¬¡è¿è¡Œ"
          fi

          echo "stored_shas<<EOF" >> $GITHUB_OUTPUT
          echo "$stored_shas" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥éª¤3: æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€
      - name: æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€
        id: check-updates
        env:
          REPOS: ${{ vars.REPOS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STORED_SHAS: ${{ steps.read-shas.outputs.stored_shas }}
        run: |
          # åˆå§‹åŒ–å˜é‡
          updates_status="### ğŸ” ä»“åº“æ›´æ–°æ£€æŸ¥æŠ¥å‘Š\n\n"
          updates_status+="### ğŸ“… æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')\n\n"
          updates_status+="---\n\n"
          has_updates=false
          updated_repos=0
          
          # åˆ¤æ–­æ˜¯å¦æ˜¯é¦–æ¬¡è¿è¡Œï¼ˆstored_shasä¸ºç©ºï¼‰
          is_first_run=false
          if [ -z "${STORED_SHAS}" ] || [ "${STORED_SHAS}" = "null" ]; then
            is_first_run=true
            echo "é¦–æ¬¡è¿è¡Œï¼Œå°†æ£€æŸ¥24å°æ—¶å†…çš„æ›´æ–°"
          fi

          # åˆå§‹åŒ–æ–°çš„SHAå­˜å‚¨å†…å®¹
          new_shas=""
          
          # å°†ç¯å¢ƒå˜é‡è½¬æ¢ä¸ºæ•°ç»„å¹¶ç«‹å³è®¡ç®—æ€»æ•°
          read -ra repos <<< "$REPOS"
          declare -i total_repos=${#repos[@]}  # ä½¿ç”¨ declare -i å£°æ˜ä¸ºæ•´æ•°å˜é‡
          
          echo "è§£æåˆ°çš„ä»“åº“æ•°é‡: $total_repos"
          echo "ä»“åº“åˆ—è¡¨:"
          for repo in "${repos[@]}"; do
            echo "- $repo"
          done
          
          echo "å¼€å§‹å¤„ç† $total_repos ä¸ªä»“åº“..."

          # åˆ›å»ºå˜é‡åˆ†åˆ«å­˜å‚¨ä¸åŒçŠ¶æ€çš„ä»“åº“ä¿¡æ¯
          updated_content=""
          not_updated_content=""
          error_content=""
          
          for repo in "${repos[@]}"; do
            echo "===================="
            echo "å¤„ç†ä»“åº“: ${repo}"
            echo "===================="
          
            # è·å–ä»“åº“ä¿¡æ¯
            repo_info=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                        -H "Authorization: token ${GITHUB_TOKEN}" \
                        "https://api.github.com/repos/${repo}")
          
            # æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
            if [[ $(echo "$repo_info" | jq -r '.message') == "Not Found" ]]; then
                echo "âŒ ä»“åº“ä¸å­˜åœ¨: ${repo}"
                # ä¸ºä¸å­˜åœ¨çš„ä»“åº“æ·»åŠ é”™è¯¯ä¿¡æ¯
                error_content+="##### âŒ ä»“åº“ï¼š[${repo}](https://github.com/${repo})\n\n"
                error_content+="ğŸ“ **æè¿°**ï¼š*ä»“åº“ä¸å­˜åœ¨*\n\n"
                error_content+="âš ï¸ **é”™è¯¯**ï¼šæœªæ‰¾åˆ°è¯¥ä»“åº“ï¼Œè¯·æ£€æŸ¥ä»“åº“åç§°æ˜¯å¦æ­£ç¡®\n\n"
                error_content+="---\n\n"
                continue
            fi
          
            # è·å–æœ€æ–°commit
            latest_commit=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                           -H "Authorization: token ${GITHUB_TOKEN}" \
                           "https://api.github.com/repos/${repo}/commits?per_page=1")
          
          
          
            # è§£æä¿¡æ¯
            current_sha=$(echo "$latest_commit" | jq -r '.[0].sha[0:7]')
            # è·å–å­˜å‚¨çš„çŸ­SHA
            stored_sha=$(echo "$STORED_SHAS" | grep -oP "${repo}:\K[a-f0-9]{7}" || echo '')
            commit_date=$(echo "$latest_commit" | jq -r '.[0].commit.committer.date')
            commit_msg=$(echo "$latest_commit" | jq -r '.[0].commit.message')
            description=$(echo "$repo_info" | jq -r '.description // "æš‚æ— æè¿°"')
          
            echo "å½“å‰SHA: $current_sha"
            echo "å­˜å‚¨SHA: $stored_sha"
            echo "æäº¤æ—¶é—´: $commit_date"
            echo "ä»“åº“æè¿°: $description"
          
            # æ›´æ–°SHAå­˜å‚¨å­—ç¬¦ä¸²
            if [ -z "$new_shas" ]; then
                new_shas="${repo}:${current_sha}"
            else
                new_shas="${new_shas}\n${repo}:${current_sha}"
            fi

            current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            current_timestamp=$(date -u -d "$current_time" +%s)
            commit_timestamp=$(date -u -d "$commit_date" +%s)
          
            # åˆ¤æ–­æ›´æ–°çŠ¶æ€
            if [ "$is_first_run" = true ]; then
                # é¦–æ¬¡è¿è¡Œï¼šæ£€æŸ¥ä»“åº“æ˜¯å¦åœ¨24å°æ—¶å†…æœ‰æ›´æ–°
                time_diff=$((current_timestamp - commit_timestamp))
                if [ $time_diff -le 86400 ]; then  # 86400ç§’ = 24å°æ—¶
                    echo "ğŸ‰ ${repo} 24å°æ—¶å†…æœ‰æ›´æ–°"
                    has_updates=true
                    ((updated_repos++)) || true
                    status_icon="âœ…"
                else
                    echo "ğŸ’¤ ${repo} 24å°æ—¶å†…æ— æ›´æ–°"
                    status_icon="âŒ"
                fi
            else
                # éé¦–æ¬¡è¿è¡Œï¼šæ¯”å¯¹çŸ­SHA
                if [ -n "$stored_sha" ] && [ "$current_sha" = "$stored_sha" ]; then
                    echo "ğŸ’¤ ${repo} æ— æ›´æ–°"
                    status_icon="âŒ"
                else
                    echo "ğŸ‰ ${repo} å‘ç°æ›´æ–°"
                    has_updates=true
                    ((updated_repos++)) || true
                    status_icon="âœ…"
                fi
            fi

            # è®¡ç®—æ—¶é—´æ˜¾ç¤º
            time_diff_seconds=$((current_timestamp - commit_timestamp))

            # æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
            if [ $time_diff_seconds -lt 60 ]; then
                time_status="${time_diff_seconds}ç§’æœªæ›´æ–°"
            elif [ $time_diff_seconds -lt 3600 ]; then
                time_diff_mins=$((time_diff_seconds / 60))
                time_status="${time_diff_mins}åˆ†é’Ÿæœªæ›´æ–°"
            elif [ $time_diff_seconds -lt 86400 ]; then
                time_diff_hours=$((time_diff_seconds / 3600))
                time_status="${time_diff_hours}å°æ—¶æœªæ›´æ–°"
            else
                time_diff_days=$((time_diff_seconds / 86400))
                time_status="${time_diff_days}å¤©æœªæ›´æ–°"
            fi

            # æ„å»ºä»“åº“ä¿¡æ¯
            repo_info_content="##### ${status_icon} ä»“åº“ï¼š[${repo}](https://github.com/${repo})\n\n"
            repo_info_content+="ğŸ“ **æè¿°**ï¼š${description}\n\n"
            repo_info_content+="â° **æ›´æ–°æ—¶é—´**ï¼š$(date -d "$commit_date" '+%Y-%m-%d %H:%M:%S %Z')\n\n"
            repo_info_content+="ğŸ“Œ **æäº¤ä¿¡æ¯**ï¼š${commit_msg}\n\n"
            repo_info_content+="â³ **çŠ¶æ€**ï¼š${time_status}\n\n"
            repo_info_content+="---\n\n"

            # æ ¹æ®æ›´æ–°çŠ¶æ€æ·»åŠ åˆ°å¯¹åº”çš„å†…å®¹ä¸­
            if [ "$status_icon" = "âœ…" ]; then
                updated_content+="$repo_info_content"
            else
                not_updated_content+="$repo_info_content"
            fi
          done

          # è®¡ç®—é”™è¯¯æ•°é‡ï¼ˆä½¿ç”¨ || true ç¡®ä¿å³ä½¿æ²¡æœ‰åŒ¹é…ä¹Ÿä¸ä¼šå¤±è´¥ï¼‰
          error_count=$(echo -e "$error_content" | grep -c "##### âŒ" || true)
          
          # æ„å»ºç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨å®é™…æ¢è¡Œç¬¦ï¼‰
          stats=$'### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n'
          stats+=$'æ€»ä»“åº“æ•°ï¼š'${total_repos}$'\n'
          stats+=$'æœ‰æ›´æ–°ï¼š'${updated_repos:-0}$'\n'
          if [ "${error_count:-0}" -gt 0 ]; then
            stats+=$'æ— æ›´æ–°ï¼š'$((total_repos - ${updated_repos:-0} - error_count))$'\n'
            stats+=$'é”™è¯¯ï¼š'${error_count}$''
          else
            stats+=$'æ— æ›´æ–°ï¼š'$((total_repos - ${updated_repos:-0}))$''
          fi
          stats+=$'\n\n---\n\n'
          
          # åˆå¹¶æ‰€æœ‰å†…å®¹ï¼Œåªåœ¨æœ‰é”™è¯¯æ—¶æ·»åŠ é”™è¯¯å†…å®¹
          if [ "${error_count:-0}" -gt 0 ]; then
            final_status="${stats}${error_content}${updated_content}${not_updated_content}"
          else
            final_status="${stats}${updated_content}${not_updated_content}"
          fi

          echo "æ‰€æœ‰ä»“åº“å¤„ç†å®Œæˆ"
          echo "æ›´æ–°çš„ä»“åº“æ•°: ${updated_repos:-0}"

          # è®¾ç½®é€šçŸ¥æ ‡é¢˜
          if [ "${error_count:-0}" -gt 0 ]; then
            if [ "${has_updates:-false}" = true ]; then
              title_status="âš ï¸ ä»“åº“æœ‰ ${updated_repos:-0} ä¸ªæ›´æ–°ï¼Œ${error_count} ä¸ªé”™è¯¯"
            else
              title_status="âš ï¸ æ— æ›´æ–°ï¼Œä½†æœ‰ ${error_count} ä¸ªä»“åº“å‡ºé”™"
            fi
          else
            if [ "${has_updates:-false}" = true ]; then
              title_status="ğŸ‰ å‘ç° ${updated_repos:-0} ä¸ªä»“åº“æ›´æ–°ï¼"
            else
              title_status="ğŸ˜´ ç›‘æ§çš„ä»“åº“æš‚æ— æ›´æ–°"
            fi
          fi

          # å°†ç»“æœä¿å­˜åˆ°GitHub Actionsè¾“å‡ºå˜é‡
          {
            echo "has_updates=${has_updates:-false}"
            echo "check_results<<EOF"
            echo -e "$final_status"  # ä½¿ç”¨ echo -e æ¥è§£æè½¬ä¹‰å­—ç¬¦
            echo "EOF"
            echo "title_status=${title_status}"
            echo "new_shas=${new_shas}"
          } >> $GITHUB_OUTPUT

      # æ­¥éª¤4: æ›´æ–°å­˜å‚¨çš„SHA
      - name: æ›´æ–°å­˜å‚¨çš„SHA
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.get-issue.outputs.issue_number }}
          NEW_SHAS: ${{ steps.check-updates.outputs.new_shas }}
        run: |
          echo "æ›´æ–°Issue #${ISSUE_NUMBER} ä¸­çš„SHAå­˜å‚¨..."
          
          # æ£€æŸ¥NEW_SHASæ˜¯å¦ä¸ºç©º
          if [ -z "${NEW_SHAS}" ]; then
            echo "âŒ æ²¡æœ‰è·å–åˆ°æ–°çš„SHAä¿¡æ¯ï¼Œè·³è¿‡æ›´æ–°"
            exit 1
          fi
          
          # æ›´æ–°Issueå†…å®¹
          if echo -e "${NEW_SHAS}" | gh issue edit "${ISSUE_NUMBER}" --body-file -; then
            echo "âœ… SHAä¿¡æ¯æ›´æ–°æˆåŠŸ"
            echo "æ›´æ–°åçš„SHAä¿¡æ¯: ${NEW_SHAS}"
          else
            echo "âŒ SHAä¿¡æ¯æ›´æ–°å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤5: å‘é€é€šçŸ¥
      - name: å‘é€é€šçŸ¥
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: candies404/Multi-Channel-Notifier@latest
        with:
          title: "${{ steps.check-updates.outputs.title_status }}"
          content: ${{ steps.check-updates.outputs.check_results }}
          wpush_key: ${{ secrets.WPUSH_KEY }}
          hitokoto: 'false'
