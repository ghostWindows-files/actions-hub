name: æ£€æŸ¥ä»“åº“æ›´æ–°

# è§¦å‘æ¡ä»¶
on:
  #  schedule:
  #    - cron: '0 0 * * *'  # æ¯å¤© UTC 0:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# å·¥ä½œæµä»»åŠ¡
jobs:
  check-updates:
    name: 'æ£€æŸ¥ä»“åº“æ›´æ–°'
    runs-on: ubuntu-latest
    steps:

      # æ­¥éª¤1: è°ƒè¯•ç¯å¢ƒå˜é‡ï¼Œç¡®è®¤å˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
      # - name: è°ƒè¯•ç¯å¢ƒå˜é‡
      #   run: |
      #     echo "${{ vars.REPOS }}"
      #     echo

      #     # æ£€æŸ¥æ ¼å¼å¹¶è¾“å‡ºé”™è¯¯
      #     has_error=false
      #     while IFS= read -r repo || [[ -n "$repo" ]]; do
      #       clean_repo=$(echo "$repo" | tr -cd '[:print:]' | sed 's/^ *//;s/ *$//')
      #       [[ -z "$clean_repo" ]] && continue

      #       if [[ ! "$clean_repo" =~ ^[a-zA-Z0-9][-a-zA-Z0-9]*/[a-zA-Z0-9][-a-zA-Z0-9_.]*$ ]]; then
      #         echo "âŒ æ— æ•ˆä»“åº“æ ¼å¼: '$clean_repo'"
      #         has_error=true
      #       fi
      #     done < <(echo "${{ vars.REPOS }}" | tr '\n' ' ' | tr -s ' ' | sed 's/^ *//;s/ *$//' | tr ' ' '\n')

      #     if [[ "$has_error" == "true" ]]; then
      #       echo
      #       echo "âœ… æ­£ç¡®æ ¼å¼ç¤ºä¾‹: owner/repo owner2/repo2 owner3/repo3"
      #       exit 1
      #     fi

      # æ­¥éª¤2: æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€
      - name: æ£€æŸ¥ä»“åº“æ›´æ–°çŠ¶æ€
        id: check-updates
        env:
          REPOS: ${{ vars.REPOS }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # set -x  # å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºæ‰§è¡Œçš„æ¯ä¸ªå‘½ä»¤
          
          # è°ƒè¯• token
          # echo "Token å‰å‡ ä¸ªå­—ç¬¦: ${GITHUB_TOKEN:0:6}..."
          
          # å°†ç¯å¢ƒå˜é‡è½¬æ¢ä¸ºæ•°ç»„å¹¶æ˜¾ç¤º
          read -ra repos <<< "$REPOS"
          echo "è§£æåˆ°çš„ä»“åº“æ•°é‡: ${#repos[@]}"
          echo "ä»“åº“åˆ—è¡¨:"
          for repo in "${repos[@]}"; do
            echo "- $repo"
          done
          
          # åˆå§‹åŒ–å˜é‡
          updates_status="### ğŸ” ä»“åº“æ›´æ–°æ£€æŸ¥æŠ¥å‘Š\n\n"
          updates_status+="### ğŸ“… æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n\n"
          updates_status+="---\n\n"
          has_updates=false
          updated_repos=0
          total_repos=${#repos[@]}
          
          # åˆ›å»ºä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨æœ‰æ›´æ–°å’Œæ— æ›´æ–°çš„ä»“åº“ä¿¡æ¯
          updated_content=""
          not_updated_content=""
          error_content=""
          
          echo "å¼€å§‹å¤„ç† ${total_repos} ä¸ªä»“åº“..."
          
          # éå†ä»“åº“åˆ—è¡¨
          for repo in "${repos[@]}"; do
            echo "===================="
            echo "å¤„ç†ä»“åº“: ${repo}"
            echo "===================="
          
            # æ·»åŠ è°ƒè¯•ä¿¡æ¯
            echo "æ­£åœ¨è·å–ä»“åº“ä¿¡æ¯..."
          
            # è°ƒç”¨GitHub APIè·å–ä»“åº“ä¿¡æ¯
            repo_info=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                       -H "Authorization: token ${GITHUB_TOKEN}" \
                       "https://api.github.com/repos/${repo}" || echo '{"message": "API call failed"}')
          
            # æ£€æŸ¥APIå“åº”
            if [[ $(echo "$repo_info" | jq -r '.message') == "Not Found" ]]; then
              echo "è­¦å‘Š: ä»“åº“ ${repo} æœªæ‰¾åˆ°"
              # ä¸ºæœªæ‰¾åˆ°çš„ä»“åº“æ·»åŠ é”™è¯¯ä¿¡æ¯
              error_content+="##### âŒ ä»“åº“ï¼š${repo}\n\n"
              error_content+="ğŸ“ **æè¿°**ï¼š*ä»“åº“ä¸å­˜åœ¨*\n\n"
              error_content+="âš ï¸ **é”™è¯¯**ï¼šæœªæ‰¾åˆ°è¯¥ä»“åº“ï¼Œè¯·æ£€æŸ¥ä»“åº“åç§°æ˜¯å¦æ­£ç¡®\n\n"
              error_content+="---\n\n"
              continue
            fi
          
            if [[ $(echo "$repo_info" | jq -r '.message') == "API call failed" ]]; then
              echo "è­¦å‘Š: è·å–ä»“åº“ä¿¡æ¯å¤±è´¥"
              # ä¸ºAPIè°ƒç”¨å¤±è´¥çš„ä»“åº“æ·»åŠ é”™è¯¯ä¿¡æ¯
              error_content+="##### âŒ ä»“åº“ï¼š${repo}\n\n"
              error_content+="ğŸ“ **æè¿°**ï¼š*è·å–ä¿¡æ¯å¤±è´¥*\n\n"
              error_content+="âš ï¸ **é”™è¯¯**ï¼šAPI è°ƒç”¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•\n\n"
              error_content+="---\n\n"
              continue
            fi
          
            echo "æ­£åœ¨è·å–æœ€æ–°æäº¤ä¿¡æ¯..."
            latest_commit=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                          -H "Authorization: token ${GITHUB_TOKEN}" \
                          "https://api.github.com/repos/${repo}/commits?per_page=1" || echo '[{"message": "API call failed"}]')
          
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–æäº¤ä¿¡æ¯
            if [[ $(echo "$latest_commit" | jq -r '.[0].commit') == "null" ]]; then
              echo "è­¦å‘Š: æ— æ³•è·å– ${repo} çš„æäº¤ä¿¡æ¯ï¼Œè·³è¿‡å¤„ç†"
              continue
            fi
          
            # è§£æAPIè¿”å›çš„JSONæ•°æ®
            commit_date=$(echo "$latest_commit" | jq -r '.[0].commit.committer.date' || echo '')
            commit_msg=$(echo "$latest_commit" | jq -r '.[0].commit.message' || echo '')
            description=$(echo "$repo_info" | jq -r '.description // "æš‚æ— æè¿°"')  
          
            if [[ -z "$commit_date" || -z "$commit_msg" ]]; then
              echo "è­¦å‘Š: è§£ææäº¤ä¿¡æ¯å¤±è´¥ï¼Œè·³è¿‡å¤„ç†"
              continue
            fi
          
            echo "è§£æçš„æ•°æ®:"
            echo "- æäº¤æ—¥æœŸ: $commit_date"
            echo "- æäº¤ä¿¡æ¯: $commit_msg"
            echo "- ä»“åº“æè¿°: $description"
          
            # è®¡ç®—æ—¶é—´å·®å¹¶æ ¼å¼åŒ–æ˜¾ç¤º
            echo "è®¡ç®—æ—¶é—´å·®..."
            current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "å½“å‰æ—¶é—´: $current_time"
            echo "æäº¤æ—¶é—´: $commit_date"

            # è®¡ç®—æ—¶é—´å·®ï¼ˆç§’ï¼‰
            current_timestamp=$(date -d "$current_time" +%s)
            commit_timestamp=$(date -d "$commit_date" +%s)
            time_diff_seconds=$((current_timestamp - commit_timestamp))
          
            # æ ¹æ®æ—¶é—´å·®é€‰æ‹©åˆé€‚çš„æ˜¾ç¤ºå•ä½
            if [ $time_diff_seconds -lt 60 ]; then
                # å°äº1åˆ†é’Ÿ
                time_status="${time_diff_seconds}ç§’æœªæ›´æ–°"
            elif [ $time_diff_seconds -lt 3600 ]; then
                # å°äº1å°æ—¶ï¼Œæ˜¾ç¤ºåˆ†é’Ÿ
                time_diff_mins=$((time_diff_seconds / 60))
                time_status="${time_diff_mins}åˆ†é’Ÿæœªæ›´æ–°"
            elif [ $time_diff_seconds -lt 86400 ]; then
                # å°äº24å°æ—¶ï¼Œæ˜¾ç¤ºå°æ—¶
                time_diff_hours=$((time_diff_seconds / 3600))
                time_status="${time_diff_hours}å°æ—¶æœªæ›´æ–°"
            else
                # å¤§äº24å°æ—¶ï¼Œæ˜¾ç¤ºå¤©æ•°
                time_diff_days=$((time_diff_seconds / 86400))
                time_status="${time_diff_days}å¤©æœªæ›´æ–°"
            fi
          
            # è®¡ç®—å°æ—¶æ•°ï¼ˆå…¼å®¹åŸæœ‰é€»è¾‘ï¼‰
            time_diff=$((time_diff_seconds / 3600))
            echo "æ—¶é—´å·®: ${time_diff} å°æ—¶"

            # åˆ¤æ–­æ˜¯å¦æœ‰æ›´æ–°ï¼ˆ24å°æ—¶å†…ï¼‰å¹¶è®¾ç½®çŠ¶æ€å›¾æ ‡
            if (( time_diff <= 24 )); then
                echo "ğŸ‰ ${repo} å‘ç°æ›´æ–° "
                has_updates=true
                ((updated_repos++)) || true
                status_icon="âœ…"
            else
                echo "ğŸ’¤ ${repo} æ— æ›´æ–° "
                status_icon="âŒ"
            fi

            # æ„å»ºä»“åº“ä¿¡æ¯
            repo_info_content="##### ${status_icon} ä»“åº“ï¼š${repo}\n\n"
            repo_info_content+="ğŸ“ **æè¿°**ï¼š${description}\n\n"
            repo_info_content+="â° **æœ€åæ›´æ–°**ï¼š$(date -d "$commit_date" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "$commit_date")\n\n"
            repo_info_content+="ğŸ“Œ **æœ€æ–°æäº¤**ï¼š${commit_msg}\n\n"
            repo_info_content+="â³ **çŠ¶æ€**ï¼š${time_status}\n\n"
            repo_info_content+="---\n\n"

            # æ ¹æ®æ›´æ–°çŠ¶æ€æ·»åŠ åˆ°å¯¹åº”çš„å†…å®¹ä¸­
            if (( time_diff <= 24 )); then
                updated_content+="$repo_info_content"
            else
                not_updated_content+="$repo_info_content"
            fi
          
            echo "å®Œæˆå¤„ç†ä»“åº“: ${repo}"
          done || true  # é˜²æ­¢å¾ªç¯é”™è¯¯å¯¼è‡´è„šæœ¬é€€å‡º
          
          echo "æ‰€æœ‰ä»“åº“å¤„ç†å®Œæˆ"
          echo "æ›´æ–°çš„ä»“åº“æ•°: ${updated_repos:-0}"
          
          # è®¾ç½®é€šçŸ¥æ ‡é¢˜
          if [ "${has_updates:-false}" = true ]; then
            title_status="ğŸ‰ å‘ç°${updated_repos:-0}ä¸ªä»“åº“æ›´æ–°ï¼"
          else
            title_status="ğŸ˜´ ç›‘æ§çš„ä»“åº“æš‚æ— æ›´æ–° "
          fi
          
          # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
          stats="### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n"
          stats+="- æ€»ä»“åº“æ•°ï¼š${total_repos}\n"
          stats+="- æœ‰æ›´æ–°ï¼š${updated_repos:-0}\n"
          stats+="- æ— æ›´æ–°ï¼š$((total_repos - ${updated_repos:-0}))\n\n"
          stats+="---\n\n"
          
          # åˆå¹¶æ‰€æœ‰å†…å®¹ï¼ˆæœ‰æ›´æ–°çš„åœ¨å‰é¢ï¼‰
          final_status="${stats}${updated_content}${not_updated_content}${error_content}"
          
          # å°†ç»“æœä¿å­˜åˆ°GitHub Actionsè¾“å‡ºå˜é‡
          {
            echo "has_updates=${has_updates:-false}"
            echo "check_results<<EOF"
            echo -e "$final_status"
            echo "EOF"
            echo "title_status=${title_status}"
          } >> $GITHUB_OUTPUT

      # æ­¥éª¤2: å‘é€é€šçŸ¥
      - name: å‘é€é€šçŸ¥
        # if: github.event_name == 'workflow_dispatch' || steps.check-updates.outputs.has_updates == 'true'  # æ‰‹åŠ¨è§¦å‘æˆ–æœ‰æ›´æ–°æ—¶å‘é€
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: candies404/Multi-Channel-Notifier@latest
        with:
          title: "${{ steps.check-updates.outputs.title_status }}"
          content: ${{ steps.check-updates.outputs.check_results }}
          wpush_key: ${{ secrets.WPUSH_KEY }}         # WxPusher çš„ API key
          hitokoto: 'false'                          # æ˜¯å¦å¯ç”¨ä¸€è¨€
