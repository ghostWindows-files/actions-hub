name: uptime-kuma æ„å»ºå¹¶æ¨é€é•œåƒ

on:
  #  schedule:
  #    - cron: '0 0 * * *' # æ¯å¤©çš„å‡Œæ™¨ 0:00 æ‰§è¡Œä¸€æ¬¡ï¼Œå³ä¸­å›½æ—©ä¸Š8ç‚¹
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  
jobs:
  Check-Update:
    name: æ£€æŸ¥æ›´æ–°
    runs-on: ubuntu-latest
    outputs:
      repo_updated: ${{ steps.check_docker_hub.outputs.repo_updated }}
      current_sha: ${{ steps.check_docker_hub.outputs.current_sha }}
      last_commit_msg: ${{ steps.check_docker_hub.outputs.last_commit_msg }}
      last_commit_author: ${{ steps.check_docker_hub.outputs.last_commit_author }}
      last_commit_date: ${{ steps.check_docker_hub.outputs.last_commit_date }}

    steps:
      - name: è®¾ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: louislam/uptime-kuma
          path: uptime-kuma
          fetch-depth: 0

      - name: æ£€æŸ¥ Docker Hub æœ€æ–°é•œåƒ
        id: check_docker_hub
        run: |
          cd uptime-kuma
          CURRENT_SHA=$(git rev-parse HEAD)
          # æ˜ç¡®æŒ‡å®šçŸ­SHAä¸º7ä½
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          COMMIT_DATE=$(git log -1 --format=%cs)
          EXPECTED_TAG="${COMMIT_DATE}-${SHORT_SHA}"
          
          echo "æ­£åœ¨æ£€æŸ¥æ ‡ç­¾: $EXPECTED_TAG"
          TAG_EXISTS=$(curl -sf "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/mirror/tags/$EXPECTED_TAG/" | jq -r '.name')
          
          if [ -z "$TAG_EXISTS" ]; then
            echo "æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°æ ‡ç­¾ $EXPECTED_TAG"
          else
            echo "Docker Hubè¿”å›çš„æ ‡ç­¾æ˜¯: $TAG_EXISTS"
          fi


          if [[ "$TAG_EXISTS" == "$EXPECTED_TAG" ]]; then
            echo "repo_updated=false" >> $GITHUB_OUTPUT
            echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
            echo "å·²å­˜åœ¨åŒ¹é…æ ‡ç­¾ï¼Œè·³è¿‡æ„å»º"
          else
            echo "repo_updated=true" >> $GITHUB_OUTPUT
            echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
            LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
            LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
            LAST_COMMIT_DATE=$(TZ='Asia/Shanghai' date -d "@$(git log -1 --format=%ct)" '+%Y-%m-%d %H:%M:%S')
            echo "last_commit_msg=$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "last_commit_author=$LAST_COMMIT_AUTHOR" >> $GITHUB_OUTPUT
            echo "last_commit_date=$LAST_COMMIT_DATE" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°åŒ¹é…æ ‡ç­¾ï¼Œè§¦å‘æ„å»º"
          fi

      # - name: è·å–æ£€æŸ¥æ—¶é—´
      #   id: check_time
      #   run: echo "check_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # - name: å‘é€æ— éœ€æ›´æ–°é€šçŸ¥
      #   if: ${{ steps.check_docker_hub.outputs.repo_updated == 'false' }}
      #   uses: candies404/Multi-Channel-Notifier@latest
      #   with:
      #     wpush_key: ${{ secrets.WPUSH_KEY }}
      #     hitokoto: 'false'
      #     title: "uptime-kuma é•œåƒæ£€æŸ¥æŠ¥å‘Š"
      #     content: |
      #       ### ğŸŸ¢ é•œåƒçŠ¶æ€æœªæ›´æ–°
      #       **æ£€æŸ¥æ—¶é—´:** ${{ steps.check_time.outputs.check_time }}
      #       **å½“å‰çŠ¶æ€:** Docker Hub å·²å­˜åœ¨æœ€æ–°ç‰ˆæœ¬é•œåƒ
      #       **ä»“åº“è·Ÿè¸ª:** [louislam/uptime-kuma](https://github.com/louislam/uptime-kuma)

  Build-and-Push:
    name: æ„å»ºå¹¶æ¨é€é•œåƒ
    runs-on: ubuntu-latest
    needs: Check-Update
    if: ${{ needs.Check-Update.outputs.repo_updated == 'true' }}
    
    steps:
      - name: è®¾ç½®æŒ‡å®šç‰ˆæœ¬ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: louislam/uptime-kuma
          path: uptime-kuma
          ref: ${{ needs.Check-Update.outputs.current_sha }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: åˆ›å»º Dockerfile
        run: |
          cat <<EOF > mirror/Dockerfile
          FROM node:20-alpine AS builder
          WORKDIR /app
          COPY package*.json ./
          # ä½¿ç”¨ç²¾ç¡®ç‰ˆæœ¬å®‰è£…å¹¶æŠ‘åˆ¶è­¦å‘Š
          RUN npm ci --legacy-peer-deps --no-audit --no-fund --prefer-offline
          COPY . .
          RUN npm run build
          # ä¸¥æ ¼ç”Ÿäº§ç¯å¢ƒä¾èµ–ä¿®å‰ª
          RUN npm prune --production --no-audit --no-fund
          FROM node:20-alpine
          WORKDIR /app
          COPY --from=builder /app/dist ./dist
          COPY --from=builder /app/server ./server
          COPY --from=builder /app/node_modules ./node_modules
          COPY --from=builder /app/package*.json ./
          COPY --from=builder /app/src ./src
          COPY --from=builder /app/db ./db
          EXPOSE 3001
          CMD ["node", "server/server.js"]
          EOF

      - name: æ„å»ºå¹¶ä¸Šä¼ é•œåƒ
        id: build_push
        env:
          IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mirror
        run: |
          cd mirror
          # ä¿æŒä¸æ£€æŸ¥é˜¶æ®µç›¸åŒçš„7ä½çŸ­SHA
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          COMMIT_DATE=$(git log -1 --format=%cs)
          TAG="${COMMIT_DATE}-${SHORT_SHA}"

          echo "é•œåƒæ ‡ç­¾ä¸º: $TAG"
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .
          
          echo "æ¨é€é•œåƒåˆ°Docker Hub..."
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest
          
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          echo "é•œåƒæ¨é€å®Œæˆ"

      - name: è·å–æ„å»ºæ—¶é—´
        id: build_time
        if: always()
        run: echo "BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: å‘é€æ„å»ºé€šçŸ¥
        uses: candies404/Multi-Channel-Notifier@latest
        if: always()
        with:
          wpush_key: ${{ secrets.WPUSH_KEY }}
          hitokoto: 'false'
          title: ${{ steps.build_push.outcome == 'success' && 'âœ… uptime-kuma æ„å»ºæˆåŠŸ' || 'âŒ uptime-kuma æ„å»ºå¤±è´¥' }}
          content: |
            ${{ format('{0}', 
              steps.build_push.outcome == 'success' 
              && format('
              ### ğŸš€ æ–°ç‰ˆæœ¬é•œåƒå·²å‘å¸ƒ
              **å‘å¸ƒæ—¶é—´:** {0}
              **é•œåƒæ ‡ç­¾:** {1}
              **æäº¤ä¿¡æ¯:** {2}
              **æäº¤ä½œè€…:** {3}
              **æäº¤æ—¶é—´:** {4}
              **é•œåƒåœ°å€:** [ç‚¹å‡»æŸ¥çœ‹](https://hub.docker.com/r/{5}/mirror/tags)',
              env.BUILD_TIME,
              env.IMAGE_TAG, 
              needs.Check-Update.outputs.last_commit_msg,
              needs.Check-Update.outputs.last_commit_author,
              needs.Check-Update.outputs.last_commit_date,
              secrets.DOCKERHUB_USERNAME)
              
              || format('
              ### ğŸ”¥ æ„å»ºå¤±è´¥éœ€å¤„ç†
              **å¤±è´¥æ—¶é—´:** {0}
              **æ„å»ºæ—¥å¿—:** [æŸ¥çœ‹è¯¦æƒ…]({1}/{2}/actions/runs/{3})',
              env.BUILD_TIME,
              github.server_url,
              github.repository,
              github.run_id)
            ) }}
